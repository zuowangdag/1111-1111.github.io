<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频和文本输入页面</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/colorui@1.5.1/dist/colorui.min.css">
    <style>
        /* 样式部分保持不变 */
    </style>
</head>
<body>
<div class="container">
    <div class="camera-section">
        <button class="camera-button" id="openCameraButton">打开摄像头</button>
    </div>
    <div class="videos">
        <div class="video-wrapper">
            <video id="video1" autoPlay playsInline muted></video>
        </div>
        <div class="video-wrapper">
            <canvas id="video2"></canvas>
        </div>
    </div>
    <div class="input-section">
        <input type="text" id="textInput" placeholder="请输入内容..." class="c-input">
        <button class="c-btn send-button" id="sendTextButton">发送文本</button>
    </div>
</div>
<script>
    const video1 = document.getElementById('video1');
    const video2Canvas = document.getElementById('video2');
    const ctx2 = video2Canvas.getContext('2d');
    let cameraStream;
    const ws = new WebSocket('wss://zuowangdag.github.io/1111-1111.github.io/ws'); // 修改为实际 WebSocket 地址

    ws.binaryType = 'arraybuffer';
    let isReceivingData = false;

    async function startCamera() {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
            video1.srcObject = cameraStream;

            video1.addEventListener('loadedmetadata', () => {
                video2Canvas.width = video1.videoWidth;
                video2Canvas.height = video1.videoHeight;
            });

            sendFrame();
        } catch (error) {
            console.error('无法访问摄像头:', error);
        }
    }

    const sendFrame = async () => {
        try {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = video1.videoWidth;
            tempCanvas.height = video1.videoHeight;

            tempCtx.drawImage(video1, 0, 0, tempCanvas.width, tempCanvas.height);

            tempCanvas.toBlob(blob => {
                if (blob) {
                    if (ws.readyState === WebSocket.OPEN) {
                        ws.send(blob);
                    } else {
                        console.error('WebSocket 连接未打开，无法发送数据');
                    }
                }
            }, 'image/jpeg', 0.8);

            requestAnimationFrame(sendFrame);
        } catch (error) {
            console.error('发送视频流失败:', error);
        }
    };

    ws.onmessage = function(event) {
        const blob = new Blob([event.data]);
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = function() {
            if (isReceivingData) {
                ctx2.clearRect(0, 0, video2Canvas.width, video2Canvas.height);
                ctx2.drawImage(img, 0, 0, video2Canvas.width, video2Canvas.height);
            }
            URL.revokeObjectURL(url);
        };
        img.src = url;
    };

    ws.onopen = function() {
        console.log('WebSocket 连接成功');
        isReceivingData = true;
    };

    ws.onerror = function(error) {
        console.error('WebSocket 错误:', error);
    };

    ws.onclose = function() {
        console.log('WebSocket 连接已关闭');
        isReceivingData = false;
    };

    document.getElementById('openCameraButton').onclick = startCamera;

    document.getElementById('sendTextButton').onclick = function() {
        const textInput = document.getElementById('textInput').value;
        if (textInput && ws.readyState === WebSocket.OPEN) {
            ws.send(textInput);
            document.getElementById('textInput').value = '';
        } else {
            console.error('WebSocket 未连接或文本框为空');
        }
    };
</script>
</body>
</html>
